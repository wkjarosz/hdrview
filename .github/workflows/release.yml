name: Publish to releases and github.io website

on:
  push:
    tags:
      - "v*.*"
      - "v*.*.*"
  workflow_dispatch:

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

jobs:
  build_macos:
    name: Build on ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          # macos-14 is an arm64 runner
          - {
              name: "macOS Apple Silicon",
              os: macos-14,
              preset: "macos-arm64-cpm",
              arch: "Apple Silicon",
              flags: "-DHDRVIEW_ENABLE_HEIC=OFF -DHDRVIEW_ENABLE_AVCI=OFF",
            }
          - {
              name: "macOS Intel",
              os: macos-15-intel,
              preset: "macos-x86_64-cpm",
              arch: "Intel",
              flags: "-DHDRVIEW_ENABLE_HEIC=OFF -DHDRVIEW_ENABLE_AVCI=OFF",
            }

    steps:
      - name: Install dependencies
        run: brew install ninja create-dmg dylibbundler jpeg-xl little-cms2 libultrahdr libheif libpng imath cli11 spdlog fmt aom libde265 x265

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version variables
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NO_V="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NO_V=$VERSION_NO_V" >> $GITHUB_ENV

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      # Setup caching of build artifacts to reduce total build time (only Linux and MacOS)
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.config.os }}-${{ matrix.config.preset }}

      - name: Configure CMake
        run: |
          cmake --preset ${{ matrix.config.preset }} -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache ${{ matrix.config.flags }}

      - name: Build
        run: cmake --build --preset ${{ matrix.config.preset }}-release

      - name: Rename app bundle with version
        run: |
          cd ${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}
          mv HDRView.app "HDRView ${VERSION_NO_V}.app"

      - name: Checking that HDRView runs
        run: |
          "${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}/HDRView ${VERSION_NO_V}.app/Contents/MacOS/HDRView" --help

      - name: Bundle dependencies
        run: |
          dylibbundler -od -b -x "${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}/HDRView ${VERSION_NO_V}.app/Contents/MacOS/HDRView" -d "${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}/HDRView ${VERSION_NO_V}.app/Contents/libs/"

      - name: Creating dmg
        run: |
          RESULT="${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}/HDRView-${VERSION} (${{ matrix.config.arch }}).dmg"
          test -f $RESULT && rm $RESULT
          for i in 1 2 3; do
            if sudo create-dmg --window-size 500 300 --icon-size 96 --volname "HDRView Installer" --app-drop-link 360 105 --icon "HDRView ${VERSION_NO_V}.app" 130 105 $RESULT "${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}/HDRView ${VERSION_NO_V}.app"; then
              break
            elif [ $i -eq 3 ]; then
              echo "create-dmg failed after 3 attempts"
              exit 1
            else
              echo "create-dmg failed, retrying ($i)..."
              sleep 2
            fi
          done

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.config.os }}-${{ matrix.config.preset }}
          path: |
            ${{github.workspace}}/build/${{ matrix.config.preset }}

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: "${{github.workspace}}/build/${{ matrix.config.preset }}/${{env.BUILD_TYPE}}/HDRView-${{ env.VERSION }} (${{ matrix.config.arch }}).dmg"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_windows:
    name: Build on Windows
    runs-on: windows-latest

    steps:
      - name: Install dependencies
        run: pip install Pillow

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version variables
        run: |
          $VERSION = "${{ github.ref_name }}"
          echo "VERSION=$VERSION" >> $env:GITHUB_ENV

      - name: Configure CMake
        run: cmake --preset windows -DHDRVIEW_ENABLE_HEIC=OFF -DHDRVIEW_ENABLE_AVCI=OFF

      - name: Build
        run: cmake --build --preset windows-release --verbose

      - name: Checking that HDRView runs
        working-directory: ${{github.workspace}}
        run: ./build/${{env.BUILD_TYPE}}/HDRView.exe --help

      - name: Copy files for archiving and release
        working-directory: ${{github.workspace}}/build
        run: |
          cmake -E copy_directory assets deploy/assets/
          cmake -E copy ${{env.BUILD_TYPE}}/HDRView.exe deploy/

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-windows-latest
          path: |
            ${{github.workspace}}/build/deploy

      - name: Archive Release
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: "zip"
          filename: "HDRView-${{ env.VERSION }}-windows.zip"
          directory: ${{github.workspace}}/build/deploy

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{github.workspace}}/build/deploy/HDRView-${{ env.VERSION }}-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_emscripten:
    name: Build and deploy emscripten webapp
    runs-on: macos-14

    steps:
      - name: Install dependencies
        run: |
          brew install ninja emscripten libpng

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      # Setup caching of build artifacts to reduce total build time (only Linux and MacOS)
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2

      - name: Configure CMake
        run: |
          emcmake cmake --preset emscripten

      - name: Build
        run: cmake --build ${{github.workspace}}/build/emscripten --parallel

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-emscripten
          path: |
            ${{github.workspace}}/build/emscripten

      - name: CPack
        working-directory: ${{github.workspace}}/build/emscripten
        run: |
          cmake --install .
          mv deploy/HDRView.html deploy/index.html

      - name: Publish
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{github.workspace}}/build/emscripten/deploy
